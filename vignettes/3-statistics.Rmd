---
title: "nmrrr - statistics"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

This vignette demonstrates the general workflow for performing multivariate statistical analyses using relative abundance data. 

This vignette uses the `relabund_cores` output generated by vignette #2.


```{r, echo=FALSE, include=FALSE}
library(tidyverse)
library(readxl)

source("code/nmrrr_workflow/1-functions_processing.R")
source("code/nmrrr_workflow/2-functions_relabund.R")

PEAKS_FILES = "data/KFP_hysteresis/peaks/"

BINSET = "Clemente2012"
bins_dat = set_bins(BINSET)

peaks_processed = import_nmr_peaks(PEAKS_FILES)
peaks_processed2 = 
  peaks_processed %>% 
  filter(group != "oalkyl")

COREKEY = "data/KFP_hysteresis/corekey.csv"
corekey = read.csv(COREKEY) %>% mutate(Core = as.character(Core))

relabund_cores = compute_relabund_cores(peaks_processed2, bins_dat, corekey)

```

---

**Note: both PERMANOVA and PCA need data in wide form.**

i.e., one column for each group, and one row for each sample

```{r}
relabund_wide = 
  relabund_cores %>% 
  ungroup() %>% 
  pivot_wider(names_from = group, values_from = relabund)
```

```{r}
head(relabund_wide)
```

---

## PERMANOVA (Permutational Multivariate Analysis of Variance)

The PERMANOVA allows us to determine if a given treatment has a statistically significant influence on the multivariate dataset.

PERMANOVA is can be computed using the `adonis()` function from the `vegan` package.

```{r}
library(vegan)

adonis(relabund_wide %>% 
         dplyr::select(where(is.numeric))  ~ 
         treatment,
       data = relabund_wide)
```

---

## PCA (Principal Components Analysis)

A PCA allows us to collapse the multivariate dataset into pseudo-variables (components). 

The PCA data can be visualized using a biplot to determine the spread of/distance among the datapoints.

A biplot can be plotted using the `ggbiplot` package, available for download from GitHub: [miraKlein/ggbiplot](https://github.com/miraKlein/ggbiplot)

Install the package from GitHub:
```{r, eval=FALSE, echo=TRUE}
install.packages("devtools")
devtools::install_github("miraKlein/ggbiplot")
```

### Perform PCA analysis

We use the wide-form of relabund for PCA. 

We split the wide-form into thw numerical data (num) and the grouping variables (grp), and perform PCA on `num`.

```{r}
fit_pca_function = function(dat){
  relabund_pca=
    dat %>% 
    ungroup %>% 
    dplyr::select(-1)
  
  num = 
    relabund_pca %>% 
    dplyr::select(c(aliphatic1, aliphatic2, aromatic, alphah, amide))
  
  grp = 
    relabund_pca %>% 
    dplyr::select(-c(aliphatic1, aliphatic2, aromatic, alphah, amide)) %>% 
    dplyr::mutate(row = row_number())
  
  pca_int = prcomp(num, scale. = T)
  
  list(num = num,
       grp = grp,
       pca_int = pca_int)
}

## PCA input files
pca_data = fit_pca_function(relabund_wide)

```

### Creating the PCA biplot

The `ggbiplot()` function follows similar nomenclature to `ggplot()` for customization.

```{r, fig.height=4, fig.width=5}
library(ggbiplot)

## PCA plot
(gg_pca = 
    ggbiplot(pca_data$pca_int, obs.scale = 1, var.scale = 1,
             groups = as.character(pca_data$grp$treatment), 
             ellipse = TRUE, circle = FALSE, var.axes = TRUE, alpha = 0) +
    geom_point(size=2,stroke=1, alpha = 0.5,
               aes(shape = groups,
                   color = groups))+
    theme_classic()+
    NULL)

```

---

<details>
  <summary>Session Info - click to open </summary>

Date run: `r Sys.Date()`


```{r, echo=FALSE}
sessionInfo()
```

</details>

---

