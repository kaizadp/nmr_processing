---
title: "nmrrr - relative abundance"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

This vignette demonstrates the general workflow for computing and reporting/graphing relative abundance data. 

The *nmrrr* package includes the capability to compute the relative abundance, but not the graphs. We provide an example script here for plotting relative abundance using stacked bar plots. 

---

This vignette uses the `peaks_processed2` output generated by vignette #1.

Relative abundances are calculated based on the integration of peaks in each region.

```{r, echo=FALSE, include=FALSE}
library(tidyverse)
library(readxl)

source("code/nmrrr_workflow/1-functions_processing.R")
PEAKS_FILES = "data/KFP_hysteresis/peaks/"

BINSET = "Clemente2012"
bins_dat = set_bins(BINSET)

peaks_processed = import_nmr_peaks(PEAKS_FILES)
peaks_processed2 = 
  peaks_processed %>% 
  filter(group != "oalkyl")
```

---

## PART 1: Setup

```{r}
source("code/nmrrr_workflow/2-functions_relabund.R")
```

Set/import the corekey

```{r}
COREKEY = "data/KFP_hysteresis/corekey.csv"
corekey = read.csv(COREKEY) %>% mutate(Core = as.character(Core))
```

Set the treatments (grouping variables) for the rel-abund calculations.

```{r}
TREATMENTS = quos(treatment)
```

We are currently using the `treatment` column as a grouping variable for the relative abundance

Users can replace this with the column names they want. 
Users can use multiple column names, just separate them with a comma: `quos(treatment1, treatment2)`

---

## PART II: Calculate relative abundances

### Step 1: Relative abundance for each sample
If there are multiple replicates for each treatment, we must first calculate relative abundance for each replicate.

These data will also be used for running multivariate statistics, e.g. PCA, PERMANOVA, etc. (see the corresponding "Statistics" vignette for more details.)

```{r}
relabund_cores = compute_relabund_cores(peaks_processed2, bins_dat, corekey)
```

```{r}
head(relabund_cores)
```


### Step 2: Relative abundance summary (for each treatment)

Use this function to compute summary statistics of relative abundance for each treatment. 

Mean, SD, SE are calculated.

This relabund_summary can be used for bar graphs and summary tables, see below.

```{r}
relabund_summary = compute_relabund_summary(relabund_cores, TREATMENTS)
```

```{r}
head(relabund_summary)
```

---

## PART III: Summary table

Use `relabund_summary`.


### Step 1: Simple table, no statistics

```{r}
relabund_summarytable = 
  relabund_summary %>% 
  mutate(relabund = paste(relabund_mean, "\u00b1", relabund_se),
         relabund = str_remove_all(relabund, " \u00b1 NA")) %>% 
  dplyr::select(group, treatment, relabund) %>% 
  pivot_wider(names_from = "treatment", values_from = "relabund") %>% 
  mutate(group = factor(group,
                        levels = c("aliphatic1", "aliphatic2", "alphah", "aromatic", "amide"))) %>% 
  arrange(group)

relabund_summarytable %>% knitr::kable()
```

### Step 2: Table with statistics

*coming soon*


---

## PART IV: Bar graphs

Use `relabund_summary`.


```{r, fig.width=5}
(relabund_bar = 
   relabund_summary %>% 
   ggplot(aes(x = treatment, y = relabund_mean, fill = group))+
   geom_bar(stat = "identity")+
   scale_fill_manual(values = rev(soilpalettes::soil_palette("redox2", 5)))+
   theme_classic()+
   NULL)
```

---

<details>
  <summary>Session Info - click to open</summary>

Date run: `r Sys.Date()`


```{r, echo=FALSE}
sessionInfo()
```

</details>

---